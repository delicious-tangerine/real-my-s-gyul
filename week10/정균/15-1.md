# `15.1 문자열(CHAR와 VARCHAR)`

문자열 컬럼을 사용할 때는 우선 `CHAR` 타입과 `VARCHAR` 타입 중 어떤 타입을 사용할지 결정해야 합니다. 
둘 중에서 뭘 선택해야 할지 고민하다가 결국 VARCHAR만 쭉 사용하는 사람들도 있는데 그게 바로 `저` 입니다.
하지만 DBMS에서 CHAR나 VARCHAR 타입을 구분해서 제공하는 것을 보면 그만큼의 장단점을 가지고 있음을 짐작할 수 있습니다. 
그래서 `저장 공간`과 `비교 방식` 관점에서 비교를 해보고, MySQL 내부적으로 어떤 차이가 있는지도 알아보겠습니다.

<br> <br>

## `15.1.1 저장 공간`

우선 CHAR와 VARCHAR의 가장 큰 공통점은 문자열을 저장할 수 있는 데이터 타입이라는 점이고, 가장 큰 차이는 고정 길이인지 가변길이인지 여부입니다. 

- 고정길이는 실제 입력되는 컬럼 값의 길이에 따라 사용하는 저장 공간의 크기가 변하지 않습니다. CHAR 타입은 이미 저장 공간의 크기가 고정적입니다. 실제 저장된 값의 유효 크기가 얼마인지 별도로 저장할 필요가 없으므로 추가로 공간이 필요하지 않습니다.
- 가변 길이는 최대로 저장할 수 있는 값의 길이는 제한돼 있지만, 그 이하 크기의 값이 저장되면 그만큼 저장공간이 줄어듭니다. 하지만 VARCHAR 타입은 저장된 값의 유효 크기가 얼마인지를 별도로 저장해 둬야 하므로 1~2바이트의 저장 공간이 추가로 더 필요합니다.

<br>

하나의 글자를 저장하기 위해 `CHAR(1)`과 `VARCHAR(1)` 타입을 사용할 때 실제 사용되는 저장 공간의 크기를 한번 살펴보겠습니다. 
우선 두 문자열 타입 모두 한 글자를 저장할 때 사용하는 문자집합에 따라 실제 저장 공간 1~3바이트까지 사용하게 됩니다.

여기서 하나의 글자가 CHAR 타입에 저장될 때는 추가적인 공간이 더 필요하지 않지만 VARCHAR 타입에 저장할 때는 문자열의 길이를 관리하기 위한 1~2 바이트의 공간을 추가적으로 더 사용합니다. VARCHAR 타입의 길이가 255바이트 이하이면 1바이트만 사용하고 타입의 길이가 256바이트 이상으로 설정되면 2바이트를 길이 저장하는 데 사용합니다.

<br> <br>

### `문자열 값의 길이가 항상 일정하다면 CHAR를 사용하고 가변적이라면 VARCHAR를 사용하는 것이 일반적`

왜 길이가 고정적일 때 `CHAR`를 사용하면 좋을까요? 실제 문자열 값의 길이가 정적이냐 가변적이냐만으로 CHAR와 VARCHAR 타입을 결정하는 것은 적절하지 않습니다. CHAR 타입과 VARCHAR 타입을 결정할 때 중요한 판단 기준은 아래와 같습니다.

- 저장되는 문자열의 길이가 대게 비슷한지?
- 컬럼의 값이 자주 변경되는지?

<br>

CHAR와 VARCHAR 타입의 선택 기준은 값의 길이도 중요하지만, 해당 컬럼의 값이 얼마나 자주 변경되는지가 타입 선택의 기준이 되어야 합니다. 

```sql
CREATE TABLE tb_test (
    fd1 INT,
    fd2 CHAR(10),
    fd3 DATETIME
);
INSERT INTO tb_test (fd1, fd2, fd3) VALUES (1, "ABCD", "2011-06-27 11:02:11")
```

![스크린샷 2021-08-20 오후 12 09 24](https://user-images.githubusercontent.com/45676906/130173176-e3fefb27-ed96-4cf3-a11d-2ff3d546dffb.png)

위의 쿼리처럼 tb_test 테이블에 CHAR(10) 타입의 `ABCD`를 저장하면 위의 그림과 같이 저장이 될 것입니다. 10바이트 중에서 4바이트만 채워진 것을 볼 수 있습니다.

이번에는 CHAR(10) 대신 VARCHAR(10)으로 변경해서 똑같은 데이터를 저장했을 때는 어떻게 저장되는지 보겠습니다.

![스크린샷 2021-08-20 오후 12 12 09](https://user-images.githubusercontent.com/45676906/130173371-c92228ce-e6e1-4f97-b54f-a5f5da086b66.png)

이번에는 빈 공가 없이 컬럼의 길이와 실제 문자만 저장이 되는 것을 볼 수 있습니다. 

- CHAR(10) 타입을 사용하는 처음 그림에서는 fd2 컬럼을 위해 공간이 10바이트가 준비되어 있으므로 그냥 변경되는 값을 업데이트만 하면 됩니다.
- VARCHAR(10) 타입을 사용하는 두 번째 그림에서는 fd2 컬럼에 4바이트 밖에 저장할 수 없는 구조로 만들어져 있습니다. "ABCDE"와 같이 길이가 더 큰 값으로 변경될 때는 레코드 자체를 다른 공간으로 옮기거나 컬럼 값의 나머지 부분을 다른 공간에 저장해야 합니다.

<br>

주민번호처럼 항상 값의 길이가 고정적일 때는 당연히 CHAR 타입을 사용해야 합니다.(VARCHAR 오타인가?) 또한 값이 2~3바이트씩 차이가 나더라도 자주 변경될 수 있는 부서 번호나 게시물의 상태 값 등은 CHAR 타입을 사용하는 것이 좋습니다.
자주 변경되어도 레코드가 물리적으로 다른 위치로 이동시키거나 분리하지 않아도 되기 때문입니다.
레코드의 이동이나 분리는 CHAR 타입으로 인해 발생하는 2~3바이트 공간 낭비보다 더 큰 공간이나 자원을 낭비하게 만듭니다.

그리고 하나 더 알아두어야 할 정믄 MySQL에서 CHAR나 VARCHAR 뒤에 지정하는 숫자는 그 컬럼의 바이트 크기가 아니라 문자의 수를 의미합니다. 예를들어 VARCHAR(10) 이라면 10바이트를 저장할 수 있는 공간이 아니라 10글자(문자)를 저장할 수 있는 공간을 의미합니다.
그래서 CHAR(10) 타입을 사용하더라도 이 컬럼이 실제적으로 디스크나 메모리에서 사용하는 공간은 각각 달라집니다.

- 일반적으로 영어를 포함한 서구권 언어는 각 문자가 1바이트를 사용하므로 10바이트를 사용합니다.
- 한국어나 일본어와 같은 아시아권 언어는 각 문자가 최대 2바이트를 사용하므로 20바이트를 사용합니다.
- UTF-8 같은 유니코드는 최대 3바이트까지 사용하므로 30바이트까지 사용할 수 있습니다.

<br> <br>

## `15.1.2 비교 방식`

MySQL에서 문자열 컬럼을 비교하는 방식은 CHAR와 VARCHAR가 거의 같습니다. CHAR 타입의 컬럼을 SELECT를 실행했을 때 다른 DBMS처럼 사용되지 않는 공간에 공백 문자가 채워져서 나오지 않습니다.
그리고 MySQL에서는 CHAR 타입이나 VARCHAR 타입을 비교할 때 컬럼 값의 뒷쪽에 붙은 공백 무자는 모두 제거하고 비교를 수행합니다.

```sql
SELECT 'ABC'='ABC   ' AS is_equal;  # TRUE
SELECT 'ABC'='   ABC' AS is_equal;  # FALSE
```

첫 번째 예제의 쿼리를 보면 `ABC`라는 문자열 뒤에 붙어 있는 3개의 공백은 있어도 없는 것처럼 비교했다는 것을 알 수 있습니다. 그리고 두 번째 쿼리의 결과를 보면 'ABC'라는 문자열 앞쪽에 위치하는 공백 문자는 유효한 문자로 비교되고 있다는 사실도 알 수 있습니다.

<br> <br>

## `문자집합(캐릭터 셋)`

MySQL 서버에서 각 테이블의 컬럼은 모두 서로 다른 문자집합을 사용해 문자열 값을 저장할 수 있습니다. 
문자집합은 문자열을 저장하는 CHAR와 VARCHAR, 그리고 TEXT 타입의 컬럼에만 설정할 수 있습니다.
한글 기반의 서비스에서는 `euckr` 또는 `utf8` 문자집합을 사용함

<br> <br>

## `콜레이션`

콜레이션은 문자열 컬럼의 값에 대한 비교나 정렬 순서를 위한 규칙을 의미합니다. 즉 비교나 정렬 작업에서 영문 대소문자를 같은 것으로 처리할지 아니면 더 크거나 작은 것으로 판단할지에 대한 규칙을 정의하는 것입니다.

<br> <br>

## `문자열 이스케이프 처리`

MySQL 에서 SQL 문장에 사용하는 문자열은 프로그래밍 언어에서처럼 `\`를 이용해 이스케이프 처리를 해주는 것이 가능합니다.

<br>

