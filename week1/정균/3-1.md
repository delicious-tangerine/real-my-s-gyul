# `3장: MySQL 아키텍쳐`

![12](https://user-images.githubusercontent.com/45676906/119228542-70d85100-bb4e-11eb-9f2a-1bf449224b0a.png)

위의 그림을 크게 3개로 나누면 아래와 같다. 

<br>

## `MySQL 엔진`

- MySQL 엔진은 클라이언트로부터 접속 및 쿼리 요청을 처리하는 `커넥션 핸들러`와 `SQL 파서` 및 `전처리기`, 쿼리의 최적화된 실행을 위한 `옵티마이저`가 중심을 이룬다.

<br>

## `스토리지 엔진`

- MySQL 엔진은 요청된 SQL 문장을 분석, 최적화 하는 DBMS의 두뇌와 비슷
- 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지부터 데이터를 읽어오는 부분은 `스토리지 엔진`이 담당

<br>

## `핸들러 API`

MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어야 할 때는 각 스토리지 엔진에게 쓰기 또는 읽기를 요청하는데, 이러한 요청을 `핸들러(Handler) 요청`이라고 하고, 여기서 사용되는 API를 `핸들러 API`라고 한다.

<br>

## `MySQL 스레딩 구조`

![11](https://user-images.githubusercontent.com/45676906/119228903-37084a00-bb50-11eb-91a5-9269db3f5e42.png)

MySQL 스레딩 모델의 그림은 위와 같습니다. 뭐가뭔지.. 싶은데 간단하게 하나씩 알아보겠다.  

- MySQL 서버는 `프로세스 기반이 아니라 스레드 기반으로 작동한다.`
- 크게 `포그라운드 스레드`, `백 그라운드 스레드`로 구분할 수 있다.

<br>

### `포그라운드 스레드`

- 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져오며, 버퍼나 캐시에 없는 경우에는 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 작업을 처리한다. 
- `InnoDB 테이블은 데이터 버퍼나 캐시까지만 포그라운드 스레드가 처리하고, 나머지 버퍼로부터 디스크까지 기록하는 작업은 백그라운드 스레드가 처리한다.`

<br>

### `백그라운드 스레드`

- InnoDB는 여러 가지 작업이 백그라운드로 처리된다. 
- `로그 스레드`와 버퍼의 데이터를 디스크로 내려 쓰는 작업을 처리하는 `쓰기 쓰레드`가 대표적

<br>

## `정리`

- SQL 처리 도중 `데이터의 쓰기 작업은 지연되어 처리될 수 있지만 데이터의 읽기 작업은 절대 연될 수 없다.`

- 대부분 상용 DBMS에는 `쓰기 작업을 버퍼링 해서 일괄 처리 기능 탐재되어 있음`
- InnoDB 또한 INSERT, UPDATE, DELETE 쿼리로 데이터가 변경되는 경우, 데이터가 디스크의 데이터 파일로 완전히 저장될 때까지 기다리지 않아도 된다. 

<br>

## `메모리 할당 및 사용 구조`

![11](https://user-images.githubusercontent.com/45676906/119229302-4f796400-bb52-11eb-8df8-9b6c39d892f4.png)

`MySQL 엔진`과 `스토리지 엔진`을 합쳐서 `MySQL 서버`라고 표현하고 있다. 

- 글로벌 메모리: 무조건 운영체제로 부터 할당한다. `모든 스레드에 의해 공유됨`
- 로컬 메모리: 클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역이다. `클라이언트 스레드별로 독립적으로 할당되며 절대 공유되어 사용되지 않는다는 특징이 있다.`

<br>


## `MySQL 쿼리 실행 과정`

![스크린샷 2021-05-22 오후 11 21 30](https://user-images.githubusercontent.com/45676906/119229783-7173e600-bb54-11eb-8426-81b1d63238a2.png)

- 대부분의 작업은 `MySQL 엔진에서 처리`, `마지막 데이터 읽기/쓰기` 작업만 `스토리지 엔진`에 의해 처리

- `핸들러는 자동차를 운전하듯이 프로그래밍 언어에서는 어떤 기능을 호출하기 위해 사용하는 운전대와 같은 역할을 하는 객체를 핸들러라고 표현`

- MySQL 서버에서는 `MySQL 엔진은 사람 역할`, `스토리지 엔진은 자동차 역할`을 하게 되는데, MySQL 엔진이 스토리지 엔진을 조정하기 위해 핸들러라는 것을 사용

<br>

## `쿼리 실행 구조`

![1212](https://user-images.githubusercontent.com/45676906/119230133-dbd95600-bb55-11eb-81fa-aa2779d3ab44.png)

- `파서`: 사용자 요청으로 들어온 쿼리 문장을 MySQL이 인식할 수 있는 최소 단위의 어휘나 기호로 분리해 트리 형태의 구조로 만들어 내는 작업을 의미

- `전처리기`: 파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인한다.

- `옵티마이저`: DBMS의 두뇌 -> 사용자의 요청으로 들어온 쿼리 문장을 가장 빠르게 처리할지 결정하는 역할

- `실행 엔진`: 옵티마이저가 도뇌라면 실행 엔진과 핸들러는 손과 발 

- `핸들러(스토리지 엔진)`: MySQL 실행 엔진의 요청에 따라 데이터를 디스크로 저장하고 디스크로부터 읽어오는 역할을 담당한다. 

<br>

## `복제(Replication)`

![1212](https://user-images.githubusercontent.com/45676906/119230561-b64d4c00-bb57-11eb-80f0-c766d5732a39.png)

- `복제`는 2대 이상의 MySQL 서버가 동일한 데이터를 담도록 실시간으로 동기화하는 기술

- 일반적으로 MySQL 복제에는 INSERT, UPDATE와 같은 쿼리를 이용해 데이터를 변경할 수 있는 MySQL 서버와 SELECT 쿼리로 데이터를 읽기만 할 수 있는 MySQL 서버로 나뉜다. 

- 전자를 `마스터(master)` 후자를 `슬레이브(Slave)`라고 함

<br>

### `마스터(Master)`

- MySQL의 바이너리 로그가 활성화되면 어떤 MySQL 서버든 마스터가 될 수 있다.

<br>

### `슬레이브(Slave)`

- 마스터 서버가 바이너리 로그를 가지고 있으면 슬레이브 서버는 릴레이 로그를 가지고 있다. 

- 슬레이브 서버의 I/O 스레드는 마스터 서버에 접속해 변경 내역을 요청하고, 받아 온 변경 내역을 릴레리 로그에 기록한다. 슬레이브 서버의 SQL 스레드가 릴레이 로그에 기록된 변경 내역을 재실행 함으로써 슬레이브 데이터를 마스커와 동일한 상태로 유지함

<br>

### `슬레이브는 하나의 마스터만 설정 가능`

- MySQL 복제에는 하나의 슬레이브는 하나의 마스터만 가질 수 있다. 

- 하나의 마스터에 N개의 슬레이브가 일반적인 형태

<br>

### `마스터와 슬레이브의 데이터 동기화를 위해 슬레이브는 읽기 전용으로 설정`

- 슬레이브는 `읽기 전용`으로 하기

<br>

### `슬레이브 서버용 장비는 마스터와 동일한 사양이 적합`

- 오히려 마스터보다 슬레이브 사양이 더 좋아야 함 (자주 변경이 있는 마스터 서버라면 특히 더!)

<br>

### `복제가 불필요한 경우에는 바이너리 로그 중지`

- 바이너리 로그를 작성하기 위해 MySQL은 큰 자원을 소모함

<br>

### `바이너리 로그와 트랙잭션 격리 수준`

- 바니어리 로그 파일은 어떤 내용이 기록되느냐에 따라 `STATEMENT 포맷 방식`과 `ROW 포맷 방식`이 있다. 

- `STATEMENT 포맷 방식`: 바이너리 로그 파일애 마스터에서 실행되는 쿼리 문장을 기록하는 방식
- `ROW 포맷 방식`: 마스터에서 실행된 쿼리에 의해 변경된 레코드 값을 기록하는 방식

<br>

## `캐시 실행`

![스크린샷 2021-05-23 오후 2 13 38](https://user-images.githubusercontent.com/45676906/119249100-12a08200-bbd1-11eb-9e54-1fedcc3e7f00.png)

- 쿼리 캐시(Query Cache)는 타 DBMS에는 없는 MySQL의 독특한 기능 중 하나

- `단어의 의미와는 달리 SQL 문장을 캐시하는 것이 아니라 쿼리의 결과를 메모리에 캐시해 두는 기능`

- 쿼리 캐시의 구조는 간단한 키와 값 구조인 Map으로 되어 있음 (키는 쿼리, 값은 쿼리의 결과)
