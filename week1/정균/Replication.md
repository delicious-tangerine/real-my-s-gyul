# `복제(Replication)`

<img width="663" alt="스크린샷 2021-08-08 오후 11 48 38" src="https://user-images.githubusercontent.com/45676906/128636159-f9faba61-123b-41b2-a943-0bca44d89877.png">

데이터베이스에서 데이터가 갈수록 대용량화돼 가는 것을 생략하면 `확작성(Scalability)`은 DBMS에서 아주 중요한 요소입니다. MySQL은 확장성을 위한 다양한 기술을 제공하는데 그 중에서 가장 일반적인 방법이 `복제(Replication)` 입니다.
`MySQL의 복제는 리플레이케이션(Replication) 이라고도 하는데, 복제는 2대 이상의 MySQL 서버가 동일한 데이터를 담도록 실시간으로 동기화하는 기술입니다.`

일반적으로 MySQL의 복제에는 `INSERT나 UPDATE와 같은 쿼리를 이용해 데이터를 변경할 수 있는 MySQL 서버`와 `SELECT 쿼리로 데이터를 읽기만 할 수 있는 MySQL 서버`로 나뉘어집니다. MySQL에서는 쓰기와 읽기의 역할로 구분해, 전자를 마스터(Master) 라고 하고, 후자를 슬레이브(Slave) 라고 합니다.

<br>

## `마스터(Master)`

기술적으로는 MySQL의 바이너리 로그가 활성화되면 어떤 MySQL 서버든 마스터가 될 수 있습니다. 일반적으로 MySQL 복제를 구성하는 경우 복제에 참여하는 여러 서버 가운데 변경이 허용되는 서버는 마스터로 한정할 때가 많습니다. 그렇지 않은 경우 복제되는 데이터의 일관성을 보장하기 어렵기 때문입니다. 
마스터 서버에서 실행되는 DML과 DDL 가운데 데이터의 구조나 내용을 변경하는 모든 쿼리 문장은 바이너리 로그에 기록합니다. 슬레이브 서버에서 변경 내역을 요청하면 마스터 장비는 그 `바이너리 로그`를 읽어 슬레이브로 넘깁니다.

<br> <br>

## `슬레이브(Slave)`

데이터(바이너리 로그)를 받아 올 마스터 장비의 정보를 가지고 있는 경우 슬레이브가 됩니다. 마스터 서버가 바이너리 로그를 가지고 있다면 슬레이브 서버는 릴레리 로그를 가지고 있습니다. 일반적으로 마스터와 슬레이브의 데이터를 동일한 상태로 유지하기 위해 슬레이브 서버는 읽기 전용으로 설정할 때가 많습니다.
슬레이브 서버의 I/O 스레드는 마스터 서버에 접속해 변경 내역을 요청하고, 받아 온 변경 내역을 `릴레이 로그`에 저장합니다.
그리고 슬레이브 서버의 SQL 스레드가 릴레이 로그에 기록된 변경 내역을 재실행함으로써 슬레이브의 데이터를 마스터와 동일한 상태로 유지합니다.

<br> <br>

## `슬레이브는 하나의 마스터만 설정 가능`

MySQL의 복제에서 하나의 슬레이브는 하나의 마스터만 가질 수 있습니다.  

<br>

## `마스터와 슬레이브 데이터 동기화를 위해 슬레이브는 읽기 전용으로 설정`

마스터와 슬레이브로 복제가 구성된 상태에서 데이터는 마스터로 접속해서 변경해야 합니다.

<br> 

## `슬레이브 서버용 장비는 마스터와 동일한 사양이 적합`

슬레이브 서버용 장비는 마스터 서버용 장비보다 한 단계 낮은 장비로 선택하려고 할 때가 있습니다. 하지만 마스터 서버에서 수 많은 동시 사용자가 실행한 데이터 변경 쿼리 문장이 슬레이브 서버에서는 하나의 스레드로 모두 처리되어야 합니다.
그래서 변경이 매주 잦은 MySQL 서버일수록 마스터 서버의 사양보다 슬레이브 서버의 사양이 더 좋아야 마스터에서 동시에 여러 개의 스레드로 실행된 쿼리가 슬레이브에서 지연되지 않고 하나의 스레드로 처리될 수 있습니다.

<br>

## `복제가 불필요한 경우에는 바이너리 로그 중지`

바이너리 로그를 작성하기 위해 MySQL이 큰 자원을 소모하고 성능이 저하됩니다. 바이너리 로그를 안정적으로 기록하기 위해 갭 락을 유지하고, 매 번 트랜잭션이 커밋될 때마다 데이터를 변경시킨 쿼리 문장을 바이너리 로그에 기록해야 합니다.

<br> <br>

## `정리하기`

MySQL의 복제는 마스터에서 처리된 내용이 `바이너리 로그`에 기록되고, 그 내용이 슬레이브 MySQL 서버로 전달되어 재실행되는 방식으로 처리됩니다. MySQL 5.0 까지는 바이너리 로그에는 마스터 MySQL 서버에서 실행된 SQL 문장이 그대로 기록되고, 슬레이브 MySQL 서버에서 똑같은 SQL 문장이 재실행되는 방식만 지원됐습니다.
MySQL 5.1 부터는 MySQL 5.0과 같이 `SQL 문장을 기록하는 방`법과 `마스터에서 변경된 데이터 레코드를 기록`하는 두 가지 방법을 제공합니다. 

- 바이너리 로그 파일에 SQL 문장을 기록하는 방식을 `문장 기반 복제(Statement based replication)` 이라고 합니다.
- 변경된 레코드를 바이너리 로그에 기록하는 방식을 `레코드 기반의 복제(Row based replication)` 이라고 합니다.

<br> <br>

# `Reference`

- Real MySQL